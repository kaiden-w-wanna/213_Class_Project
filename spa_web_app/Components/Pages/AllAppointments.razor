@page "/appointments/all"
@* 1. FIX: Add Render Mode so buttons/inputs work *@
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Receptionist,Manager,Admin")]

@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using spa_web_app.Models
@using spa_web_app.Services

@inject IAppointmentService AppointmentService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>All Appointments</PageTitle>

<h3>All Appointments</h3>

<div class="mb-3">
    <label class="form-label">Select Date:</label>
    @* 2. FIX: Use @bind-Value:after to trigger load on change *@
    <InputDate class="form-control"
               @bind-Value="_selectedDate"
               @bind-Value:after="LoadAppointments" />
</div>

@if (_isLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else if (_appointments == null || !_appointments.Any())
{
    <div class="alert alert-info">No appointments found for @_selectedDate.ToShortDateString().</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Service</th>
                    <th>Time</th>
                    <th>Customer</th>
                    <th>Therapist</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var a in _appointments)
                {
                    <tr>
                        <td>@a.ServiceName</td>
                        @* Added formatting for readability *@
                        <td>@($"{a.StartTime:h:mm tt}") - @($"{a.EndTime:h:mm tt}")</td>
                        <td>@(a.Customer?.UserName ?? "Unknown")</td>
                        <td>@(a.Therapist?.UserName ?? "Unassigned")</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(a.Status)">@a.Status</span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private DateTime _selectedDate = DateTime.Today;
    private List<Appointment>? _appointments;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Initial load
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        _isLoading = true;
        // Force UI update to show spinner immediately
        StateHasChanged();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        try
        {
            // Note: Ensure this service method returns ALL appointments for the date,
            // and doesn't filter by 'user.Id' (since 'user' here is the Admin).
            _appointments = (await AppointmentService.GetAllAppointmentsForDateAsync(_selectedDate, user))
                            .OrderBy(a => a.StartTime)
                            .ToList();
        }
        catch
        {
            _appointments = new List<Appointment>();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Confirmed" => "bg-success",
        "Cancelled" => "bg-danger",
        "Completed" => "bg-secondary",
        _ => "bg-primary"
    };
}