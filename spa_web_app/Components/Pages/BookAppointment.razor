@page "/appointments/book"
@* 1. This line makes the page interactive (SPA mode), stopping the page reload issue *@
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using System
@using System.Collections.Generic
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using spa_web_app.Models
@using spa_web_app.Services

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<IdentityUser> UserManager
@inject IAppointmentService AppointmentService

<PageTitle>Book Appointment</PageTitle>

<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="display-6 mb-3">Book an Appointment</h1>
            <p class="lead">
                Choose a service, pick a date and time, and select an available therapist.
                You can manage your upcoming appointments below.
            </p>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="row">
            <div class="col-12">
                <p>Loading...</p>
            </div>
        </div>
    }
    else if (!_isAuthenticated)
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning">You must be logged in to book an appointment.</div>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            <div class="col-lg-6">
                <section class="p-4 bg-white rounded shadow-sm">
                    <h4 class="mb-3">New booking</h4>

                    <EditForm Model="_input" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @if (!string.IsNullOrEmpty(_statusMessage))
                        {
                            <div class="alert alert-info">@_statusMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Service</label>
                            <InputSelect class="form-select" @bind-Value="_input.ServiceName" @after="LoadAvailableTherapists">
                                @foreach (var option in _serviceOptions)
                                {
                                    <option value="@option.Name">@option.Name</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <InputDate class="form-control" @bind-Value="_input.Date" @after="LoadAvailableTherapists" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Time</label>
                            <InputSelect class="form-select" @bind-Value="_input.Time" @after="LoadAvailableTherapists">
                                <option value="">-- Select Time --</option>
                                @foreach (var t in _timeSlots)
                                {
                                    <option value="@Convert.ToString(t)">@t.ToString(@"hh\:mm")</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Therapist</label>
                            <InputSelect class="form-select" @bind-Value="_input.TherapistId" disabled="@(!_availableTherapists.Any())">
                                <option value="">-- Select Therapist --</option>
                                @foreach (var t in _availableTherapists)
                                {
                                    <option value="@t.Id">@t.UserName</option>
                                }
                            </InputSelect>

                            @if (!_availableTherapists.Any())
                            {
                                <small class="text-muted">No therapists available for the selected time.</small>
                            }
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                                @(_isSubmitting ? "Booking..." : "Book Appointment")
                            </button>
                        </div>
                    </EditForm>
                </section>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isAuthenticated;
    private bool _isSubmitting;
    private string? _currentUserId;
    private string? _statusMessage;

    private List<IdentityUser> _availableTherapists = new();

    private readonly List<ServiceOption> _serviceOptions = new()
    {
        new ServiceOption("Swedish Massage (60 min)", TimeSpan.FromMinutes(60)),
        new ServiceOption("Deep Tissue Massage (90 min)", TimeSpan.FromMinutes(90)),
        new ServiceOption("Facial (45 min)", TimeSpan.FromMinutes(45)),
        new ServiceOption("Body Scrub (60 min)", TimeSpan.FromMinutes(60)),
    };

    private readonly Dictionary<string, TimeSpan> _serviceDurations;
    private readonly Dictionary<string, decimal> _servicePrices = new()
    {
        { "Swedish Massage (60 min)", 80m },
        { "Deep Tissue Massage (90 min)", 120m },
        { "Facial (45 min)", 70m },
        { "Body Scrub (60 min)", 90m },
    };

    private List<TimeSpan> _timeSlots = new();

    public BookAppointment()
    {
        _serviceDurations = _serviceOptions.ToDictionary(s => s.Name, s => s.DefaultDuration);

        // Generates time slots from 9:00 AM to 5:00 PM (9*60 to 17*60) in 15-minute increments
        _timeSlots = Enumerable.Range(0, (8 * 4) + 1)
                               .Select(i => TimeSpan.FromMinutes(9 * 60 + i * 15))
                               .Where(t => t.Hours < 17) // Stop before 5 PM
                               .ToList();
    }

    private AppointmentInputModel _input = new AppointmentInputModel
    {
        ServiceName = "Swedish Massage (60 min)",
        Date = DateTime.Today.AddDays(1),
        Time = TimeSpan.FromHours(9)
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity != null && user.Identity.IsAuthenticated;

        if (_isAuthenticated)
        {
            var identityUser = await UserManager.GetUserAsync(user);
            _currentUserId = identityUser?.Id;
        }

        // Ensure the initial time is always loaded
        await LoadAvailableTherapists();
        _isLoading = false;
    }

    private async Task LoadAvailableTherapists()
    {
        _availableTherapists.Clear();

        if (_input.Date == null || _input.Time == null) return;

        // 1. Calculate the local start time
        var selectedLocalDateTime = _input.Date.Value.Date + _input.Time.Value;

        // 2. *** FIX: Convert local time to UTC time for the service layer ***
        var startUtc = selectedLocalDateTime.ToUniversalTime();

        var duration = _serviceDurations.TryGetValue(_input.ServiceName, out var d) ? d : TimeSpan.FromMinutes(60);

        // 3. Calculate the UTC end time
        var endUtc = startUtc.Add(duration);

        // Use the UTC times for the database query
        _availableTherapists = (await AppointmentService.GetAvailableTherapistsAsync(startUtc, endUtc)).ToList();

        // If a therapist was selected and is no longer available, clear the selection
        if (!string.IsNullOrEmpty(_input.TherapistId) && !_availableTherapists.Any(t => t.Id == _input.TherapistId))
        {
            _input.TherapistId = null;
        }

        // Refresh UI
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        if (!_isAuthenticated || string.IsNullOrEmpty(_currentUserId))
        {
            _statusMessage = "You must be logged in to book an appointment.";
            return;
        }

        _isSubmitting = true;
        _statusMessage = null;

        try
        {
            // 1. Calculate local start time
            var startLocal = _input.Date.Value.Date + _input.Time.Value;
            // 2. *** FIX: Convert to UTC before saving ***
            var startTimeUtc = startLocal.ToUniversalTime();

            var duration = _serviceDurations.TryGetValue(_input.ServiceName, out var d) ? d : TimeSpan.FromMinutes(60);

            // 3. Calculate UTC end time
            var endTimeUtc = startTimeUtc.Add(duration);

            var price = _servicePrices.TryGetValue(_input.ServiceName, out var p) ? p : 0m;

            await AppointmentService.CreateAppointmentAsync(
                _currentUserId!,
                _input.ServiceName,
                startTimeUtc, // Use UTC
                endTimeUtc,    // Use UTC
                price,
                _input.TherapistId);

            _statusMessage = "Appointment booked successfully! You can view it under My Appointments.";

            // Clear the form for the next booking
            _input = new AppointmentInputModel
            {
                ServiceName = "Swedish Massage (60 min)",
                Date = DateTime.Today.AddDays(1),
                Time = TimeSpan.FromHours(9)
            };

            // Re-run the therapist load for the cleared form
            await LoadAvailableTherapists();
        }
        catch (Exception ex)
        {
            _statusMessage = "An error occurred: " + ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    public class AppointmentInputModel
    {
        [Required(ErrorMessage = "Please select a service.")]
        public string ServiceName { get; set; } = "Swedish Massage (60 min)";

        [Required(ErrorMessage = "Please select a date.")]
        public DateTime? Date { get; set; }

        [Required(ErrorMessage = "Please select a time.")]
        public TimeSpan? Time { get; set; }

        [Required(ErrorMessage = "Please select an available therapist.")]
        public string? TherapistId { get; set; }
    }

    private sealed class ServiceOption
    {
        public ServiceOption(string name, TimeSpan duration)
        {
            Name = name;
            DefaultDuration = duration;
        }

        public string Name { get; }
        public TimeSpan DefaultDuration { get; }
    }
}